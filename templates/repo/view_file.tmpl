<div {{if .ReadmeInList}}id="readme"{{end}} class="{{TabSizeClass .Editorconfig .FileTreePath}} non-diff-file-content"
	data-global-init="initRepoFileView" data-raw-file-link="{{.RawFileLink}}">

	{{- if .FileError}}
		<div class="ui error message">
			<div class="text left tw-whitespace-pre">{{.FileError}}</div>
		</div>
	{{end}}
	{{- if .FileWarning}}
		<div class="ui warning message">
			<div class="text left tw-whitespace-pre">{{.FileWarning}}</div>
		</div>
	{{end}}

	{{if not .ReadmeInList}}
		<div id="repo-file-commit-box" class="ui segment list-header tw-mb-4 tw-flex tw-justify-between">
			{{template "repo/latest_commit" .}}
			{{if .LatestCommit}}
				{{if .LatestCommit.Committer}}
					<div class="text grey age flex-text-block">
						{{DateUtils.TimeSince .LatestCommit.Committer.When}}
					</div>
				{{end}}
			{{end}}
		</div>
	{{end}}

	<h4 class="file-header ui top attached header tw-flex tw-items-center tw-justify-between tw-flex-wrap">
		<div class="file-header-left tw-flex tw-items-center tw-py-2 tw-pr-4">
			{{if .ReadmeInList}}
				{{svg "octicon-book" 16 "tw-mr-2"}}
				<strong><a class="muted" href="#readme">{{.ReadmeInList}}</a></strong>
			{{else}}
				{{template "repo/file_info" .}}
			{{end}}
		</div>
		<div class="file-header-right file-actions flex-text-block tw-flex-wrap">
			{{/* this componment is also controlled by frontend plugin renders */}}
			<div class="ui compact icon buttons file-view-toggle-buttons {{if or (not .HasSourceRenderedToggle) (ne .DiagramType "none")}}tw-hidden{{end}}">
				{{if .IsRepresentableAsText}}
				<a href="?display=source" class="ui mini basic button file-view-toggle-source {{if .IsDisplayingSource}}active{{end}}" data-tooltip-content="{{ctx.Locale.Tr "repo.file_view_source"}}">{{svg "octicon-code" 15}}</a>
				{{end}}
				<a href="?display=rendered" class="ui mini basic button file-view-toggle-rendered {{if not .IsDisplayingSource}}active{{end}}" data-tooltip-content="{{ctx.Locale.Tr "repo.file_view_rendered"}}">{{svg "octicon-file" 15}}</a>
			</div>
			{{if not .ReadmeInList}}
				<div class="ui buttons tw-mr-1">
					<a class="ui mini basic button" href="{{$.RawFileLink}}">{{ctx.Locale.Tr "repo.file_raw"}}</a>
					{{if or .RefFullName.IsBranch .RefFullName.IsTag}}
						<a class="ui mini basic button" href="{{.RepoLink}}/src/commit/{{PathEscape .CommitID}}/{{PathEscapeSegments .TreePath}}">{{ctx.Locale.Tr "repo.file_permalink"}}</a>
					{{end}}
					{{if .IsRepresentableAsText}}
						<a class="ui mini basic button" href="{{.RepoLink}}/blame/{{.RefTypeNameSubURL}}/{{PathEscapeSegments .TreePath}}">{{ctx.Locale.Tr "repo.blame"}}</a>
					{{end}}
					<a class="ui mini basic button" href="{{.RepoLink}}/commits/{{.RefTypeNameSubURL}}/{{PathEscapeSegments .TreePath}}">{{ctx.Locale.Tr "repo.file_history"}}</a>
					{{if .EscapeStatus.Escaped}}
						<button class="ui mini basic button unescape-button tw-hidden">{{ctx.Locale.Tr "repo.unescape_control_characters"}}</button>
						<button class="ui mini basic button escape-button">{{ctx.Locale.Tr "repo.escape_control_characters"}}</button>
					{{end}}
				</div>
				<a download class="btn-octicon" data-tooltip-content="{{ctx.Locale.Tr "repo.download_file"}}" href="{{$.RawFileLink}}">{{svg "octicon-download"}}</a>
				<a class="btn-octicon {{if not .CanCopyContent}}disabled{{end}}" data-global-click="onCopyContentButtonClick"
					{{if not .IsDisplayingSource}}data-raw-file-link="{{$.RawFileLink}}"{{end}}
					data-tooltip-content="{{if .CanCopyContent}}{{ctx.Locale.Tr "copy_content"}}{{else}}{{ctx.Locale.Tr "copy_type_unsupported"}}{{end}}"
				>{{svg "octicon-copy"}}</a>
				{{if .Repository.CanEnableEditor}}
					{{if .CanEditFile}}
						<a class="btn-octicon" data-tooltip-content="{{.EditFileTooltip}}" href="{{.RepoLink}}/_edit/{{PathEscapeSegments .BranchName}}/{{PathEscapeSegments .TreePath}}">{{svg "octicon-pencil"}}</a>
					{{else}}
						<span class="btn-octicon disabled" data-tooltip-content="{{.EditFileTooltip}}">{{svg "octicon-pencil"}}</span>
					{{end}}
					{{if .CanDeleteFile}}
						<a class="btn-octicon btn-octicon-danger" data-tooltip-content="{{.DeleteFileTooltip}}" href="{{.RepoLink}}/_delete/{{PathEscapeSegments .BranchName}}/{{PathEscapeSegments .TreePath}}">{{svg "octicon-trash"}}</a>
					{{else}}
						<span class="btn-octicon disabled" data-tooltip-content="{{.DeleteFileTooltip}}">{{svg "octicon-trash"}}</span>
					{{end}}
				{{end}}
			{{else if .EscapeStatus.Escaped}}
				<button class="ui mini basic button unescape-button tw-mr-1 tw-hidden">{{ctx.Locale.Tr "repo.unescape_control_characters"}}</button>
				<button class="ui mini basic button escape-button tw-mr-1">{{ctx.Locale.Tr "repo.escape_control_characters"}}</button>
			{{end}}
			{{if and .ReadmeInList .CanEditReadmeFile}}
				<a class="btn-octicon" data-tooltip-content="{{ctx.Locale.Tr "repo.editor.edit_this_file"}}" href="{{.RepoLink}}/_edit/{{PathEscapeSegments .BranchName}}/{{PathEscapeSegments .FileTreePath}}">{{svg "octicon-pencil"}}</a>
			{{end}}
		</div>
	</h4>

	<div class="ui bottom attached table unstackable segment {{if ne .DiagramType "none"}}diagram-view-shell{{end}}">
		{{template "repo/view_file_dvsxml" .}}
		{{template "repo/view_file_processgit_viewer" .}}
		{{template "repo/view_file_xsd_visual" .}}
		{{template "repo/view_file_mermaid" .}}
		{{if and (ne .DiagramType "none") .DiagramPayload}}
			<div class="diagram-viewer" data-global-init="initRepoDiagrams" data-diagram-type="{{.DiagramType}}" data-diagram-format="{{.DiagramFormat}}" data-diagram-raw-panel="diagram-raw-view">
				<div class="diagram-toolbar tw-flex tw-items-center tw-justify-between tw-gap-2 tw-mb-3">
					<div class="ui buttons diagram-mode-buttons">
						<button class="ui button active" data-diagram-action="preview">{{ctx.Locale.Tr "preview"}}</button>
						{{if .DiagramEditable}}
							<button class="ui button" data-diagram-action="edit">{{ctx.Locale.Tr "repo.editor.edit_file"}}</button>
						{{end}}
						<button class="ui button" data-diagram-action="raw">{{ctx.Locale.Tr "repo.file_view_source"}}</button>
					</div>
					<div class="tw-flex tw-gap-2 tw-items-center">
						{{if .DiagramEditable}}
							<button class="ui primary button diagram-save-button tw-hidden" data-diagram-action="save" disabled>{{ctx.Locale.Tr "save"}}</button>
						{{end}}
						{{if and (not .DiagramEditable) .DiagramSourcePath}}
							<a class="ui button diagram-edit-source" href="{{.RepoLink}}/src/{{.RefTypeNameSubURL}}/{{PathEscapeSegments .DiagramSourcePath}}">{{ctx.Locale.Tr "repo.editor.edit_this_file"}}</a>
						{{end}}
					</div>
				</div>
				<div class="diagram-stage tw-flex tw-gap-3">
					<div id="diagram-canvas" class="diagram-canvas"></div>
					{{if .DiagramEditable}}
						<div id="diagram-properties" class="diagram-properties tw-hidden"></div>
					{{end}}
				</div>
				{{if .DiagramPayload}}
					<script type="application/json" id="diagram-payload">{{JsonUtils.Encode .DiagramPayload}}</script>
				{{end}}
			</div>
		{{end}}

		<div id="diagram-raw-view" class="diagram-raw-view {{if or (ne .DiagramType "none") .IsDVSXML .IsProcessGitViewer .IsXSDVisual}}tw-hidden{{end}}">
			{{if not .IsMarkup}}
				{{template "repo/unicode_escape_prompt" dict "EscapeStatus" .EscapeStatus}}
			{{end}}
			<div class="file-view {{if .IsMarkup}}markup {{.MarkupType}}{{else if .IsPlainText}}plain-text{{else if .IsDisplayingSource}}code-view{{end}}">
				{{if .IsFileTooLarge}}
					{{template "shared/filetoolarge" dict "RawFileLink" .RawFileLink}}
				{{else if not .FileSize}}
					{{template "shared/fileisempty"}}
				{{else if .IsMarkup}}
					{{.FileContent}}
				{{else if .IsPlainText}}
					<pre>{{if .FileContent}}{{.FileContent}}{{end}}</pre>
				{{else if .FileContent}}
					<table>
						<tbody>
						{{range $idx, $code := .FileContent}}
							{{$line := Eval $idx "+" 1}}
							<tr>
								<td class="lines-num"><span id="L{{$line}}" data-line-number="{{$line}}"></span></td>
								{{if $.EscapeStatus.Escaped}}
									<td class="lines-escape">{{if (index $.LineEscapeStatus $idx).Escaped}}<button class="toggle-escape-button btn interact-bg" title="{{if (index $.LineEscapeStatus $idx).HasInvisible}}{{ctx.Locale.Tr "repo.invisible_runes_line"}} {{end}}{{if (index $.LineEscapeStatus $idx).HasAmbiguous}}{{ctx.Locale.Tr "repo.ambiguous_runes_line"}}{{end}}"></button>{{end}}</td>
								{{end}}
								<td rel="L{{$line}}" class="lines-code chroma"><code class="code-inner">{{$code}}</code></td>
							</tr>
						{{end}}
						</tbody>
					</table>
				{{else}}
					<div class="view-raw">
						{{if .IsImageFile}}
							<img alt="{{$.RawFileLink}}" src="{{$.RawFileLink}}">
						{{else if .IsVideoFile}}
							<video controls src="{{$.RawFileLink}}">
								<strong>{{ctx.Locale.Tr "repo.video_not_supported_in_browser"}}</strong>
							</video>
						{{else if .IsAudioFile}}
							<audio controls src="{{$.RawFileLink}}">
								<strong>{{ctx.Locale.Tr "repo.audio_not_supported_in_browser"}}</strong>
							</audio>
						{{else}}
							<div class="file-view-render-container">
								<div class="file-view-raw-prompt tw-p-4">
									<a href="{{$.RawFileLink}}" rel="nofollow">{{ctx.Locale.Tr "repo.file_view_raw"}}</a>
								</div>
							</div>
						{{end}}
					</div>
				{{end}}
			</div>

			<div class="code-line-menu tippy-target">
				{{if $.Permission.CanRead ctx.Consts.RepoUnitTypeIssues}}
				<a class="item ref-in-new-issue" role="menuitem" data-url-issue-new="{{.RepoLink}}/issues/new" data-url-param-body-link="{{.Repository.Link}}/src/commit/{{PathEscape .CommitID}}/{{PathEscapeSegments .TreePath}}{{if $.HasSourceRenderedToggle}}?display=source{{end}}" rel="nofollow noindex">{{ctx.Locale.Tr "repo.issues.context.reference_issue"}}</a>
				{{end}}
				<a class="item view_git_blame" role="menuitem" href="{{.Repository.Link}}/blame/commit/{{PathEscape .CommitID}}/{{PathEscapeSegments .TreePath}}">{{ctx.Locale.Tr "repo.view_git_blame"}}</a>
				<a class="item copy-line-permalink" role="menuitem" data-url="{{.Repository.Link}}/src/commit/{{PathEscape .CommitID}}/{{PathEscapeSegments .TreePath}}{{if $.HasSourceRenderedToggle}}?display=source{{end}}">{{ctx.Locale.Tr "repo.file_copy_permalink"}}</a>
			</div>
		</div>
	</div>
{{if and .BlobName (or (eq .BlobName "processgit.mcp.yaml") (StringUtils.HasSuffix .BlobName ".mcp.yaml"))}}
<script>
// Copy MCP URL with visual feedback
function copyMCPUrl(url, button) {
	navigator.clipboard.writeText(url).then(function() {
		const originalHTML = button.innerHTML;
		button.innerHTML = '<svg viewBox="0 0 16 16" class="svg octicon-check" width="14" height="14"><path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0"/></svg> Copied!';
		button.classList.add('positive');
		setTimeout(function() {
			button.innerHTML = originalHTML;
			button.classList.remove('positive');
		}, 2000);
	}).catch(function(err) {
		console.error('Copy failed:', err);
		alert('Failed to copy URL: ' + err.message);
	});
}

// Test MCP connection with loading state
function testMCPConnection(url, button) {
	const originalHTML = button.innerHTML;
	button.innerHTML = '<svg viewBox="0 0 16 16" class="svg octicon-sync" width="14" height="14"><path d="M1.705 8.005a.75.75 0 0 1 .834.656 5.5 5.5 0 0 0 9.592 2.97l-1.204-1.204a.25.25 0 0 1 .177-.427h3.646a.25.25 0 0 1 .25.25v3.646a.25.25 0 0 1-.427.177l-1.38-1.38A7.002 7.002 0 0 1 1.05 8.84a.75.75 0 0 1 .656-.834ZM8 2.5a5.487 5.487 0 0 0-4.131 1.869l1.204 1.204A.25.25 0 0 1 4.896 6H1.25A.25.25 0 0 1 1 5.75V2.104a.25.25 0 0 1 .427-.177l1.38 1.38A7.002 7.002 0 0 1 14.95 7.16a.75.75 0 0 1-1.49.178A5.5 5.5 0 0 0 8 2.5"/></svg> Testing...';
	button.disabled = true;

	fetch(url, {
		method: 'POST',
		headers: {'Content-Type': 'application/json'},
		body: JSON.stringify({
			jsonrpc: '2.0',
			id: 1,
			method: 'initialize',
			params: {
				protocolVersion: '2025-03-26',
				capabilities: {},
				clientInfo: {name: 'processgit-ui', version: '1.0'}
			}
		})
	})
	.then(function(response) {
		if (!response.ok) throw new Error('HTTP ' + response.status);
		return response.json();
	})
	.then(function(data) {
		if (data.result && data.result.serverInfo) {
			button.innerHTML = '<svg viewBox="0 0 16 16" class="svg octicon-check" width="14" height="14"><path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0"/></svg> Active: ' + data.result.serverInfo.name;
			button.classList.add('positive');
		} else {
			button.innerHTML = '<svg viewBox="0 0 16 16" class="svg octicon-x" width="14" height="14"><path d="M3.72 3.72a.75.75 0 0 1 1.06 0L8 6.94l3.22-3.22a.749.749 0 0 1 1.275.326.749.749 0 0 1-.215.734L9.06 8l3.22 3.22a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L8 9.06l-3.22 3.22a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042L6.94 8 3.72 4.78a.75.75 0 0 1 0-1.06"/></svg> Invalid Response';
			button.classList.add('negative');
		}
		setTimeout(function() {
			button.innerHTML = originalHTML;
			button.classList.remove('positive', 'negative');
			button.disabled = false;
		}, 3000);
	})
	.catch(function(err) {
		button.innerHTML = '<svg viewBox="0 0 16 16" class="svg octicon-x" width="14" height="14"><path d="M3.72 3.72a.75.75 0 0 1 1.06 0L8 6.94l3.22-3.22a.749.749 0 0 1 1.275.326.749.749 0 0 1-.215.734L9.06 8l3.22 3.22a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L8 9.06l-3.22 3.22a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042L6.94 8 3.72 4.78a.75.75 0 0 1 0-1.06"/></svg> Failed: ' + err.message;
		button.classList.add('negative');
		setTimeout(function() {
			button.innerHTML = originalHTML;
			button.classList.remove('negative');
			button.disabled = false;
		}, 3000);
	});
}

// Position popup relative to badge
function positionPopup(badge, popup) {
	var rect = badge.getBoundingClientRect();
	popup.style.position = 'fixed';
	popup.style.top = (rect.bottom + 6) + 'px';
	popup.style.left = rect.left + 'px';
	// Prevent right overflow
	requestAnimationFrame(function() {
		var popupRect = popup.getBoundingClientRect();
		if (popupRect.right > window.innerWidth - 10) {
			popup.style.left = (window.innerWidth - popupRect.width - 10) + 'px';
		}
	});
}

// Initialize MCP popups with vanilla JS
document.addEventListener('DOMContentLoaded', function() {
	// File badge: toggle on click
	var fileBadge = document.getElementById('mcp-file-badge');
	var filePopup = document.getElementById('mcp-file-popup');
	if (fileBadge && filePopup) {
		fileBadge.addEventListener('click', function(e) {
			e.stopPropagation();
			var isVisible = filePopup.style.display !== 'none';
			// Hide all MCP popups first
			document.querySelectorAll('#mcp-file-popup, #mcp-header-popup').forEach(function(p) { p.style.display = 'none'; });
			if (!isVisible) {
				filePopup.style.display = 'block';
				positionPopup(fileBadge, filePopup);
			}
		});
		filePopup.addEventListener('click', function(e) { e.stopPropagation(); });
	}

	// Header badge: show on hover
	var headerBadge = document.getElementById('mcp-header-badge');
	var headerPopup = document.getElementById('mcp-header-popup');
	if (headerBadge && headerPopup) {
		var hideTimer = null;
		function showHeaderPopup() {
			if (hideTimer) { clearTimeout(hideTimer); hideTimer = null; }
			document.querySelectorAll('#mcp-file-popup').forEach(function(p) { p.style.display = 'none'; });
			headerPopup.style.display = 'block';
			positionPopup(headerBadge, headerPopup);
		}
		function scheduleHideHeaderPopup() {
			hideTimer = setTimeout(function() { headerPopup.style.display = 'none'; }, 200);
		}
		headerBadge.addEventListener('mouseenter', showHeaderPopup);
		headerBadge.addEventListener('mouseleave', scheduleHideHeaderPopup);
		headerPopup.addEventListener('mouseenter', function() {
			if (hideTimer) { clearTimeout(hideTimer); hideTimer = null; }
		});
		headerPopup.addEventListener('mouseleave', scheduleHideHeaderPopup);
	}

	// Close popups when clicking outside
	document.addEventListener('click', function() {
		if (filePopup) filePopup.style.display = 'none';
		if (headerPopup) headerPopup.style.display = 'none';
	});
});
</script>
{{end}}
</div>

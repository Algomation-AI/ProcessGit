services:
  processgit:
    container_name: processgit
    restart: unless-stopped
    build:
      context: ..  
      dockerfile: deploy/Dockerfile.processgit
    image: processgit:0.1
    depends_on:
      - processgit-init-perms
    ports:
      - "18080:3000"
      - "12222:22"
    volumes:
      - processgit-data:/data
    environment:
      USER_UID: "1000"
      USER_GID: "1000"
      APP_NAME: "ProcessGit: Git for Processes"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3000/api/v1/version >/dev/null 2>&1 || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 30

  processgit-bootstrap:
    image: processgit:0.1
    depends_on:
      processgit:
        condition: service_healthy
    volumes:
      - processgit-data:/data
    env_file:
      - ../.env
    environment:
      - PROCESSGIT_ADMIN_TOKEN=${PROCESSGIT_ADMIN_TOKEN}
      - PROCESSGIT_API_BASE=http://processgit:3000/api/v1
    restart: "no"
    entrypoint: ["/bin/sh", "-lc"]
    command: ["/opt/processgit/bootstrap/bootstrap-templates.sh"]

  processgit-init-perms:
    image: processgit:0.1
    user: "0:0"
    volumes:
      - processgit-data:/data
    entrypoint: ["/bin/sh", "-lc"]
    command: ["mkdir -p /data /data/.processgit /data/gitea && chown -R 1000:1000 /data"]
    restart: "no"

volumes:
  processgit-data:
